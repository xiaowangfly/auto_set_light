#include<analogWrite.h>//NANO中不需要，但ESP32要额外安库
#include<ssd1306.h>//oled库
//变阻器向左转动输出值变大，根据现实向右灯亮
//光敏电阻获得的光越暗返回值越高
int states = 0;//模式设定
int buttonIn = 3;//切换模式按钮
int lightIn = 4;//设置小灯引脚，模拟输出支持4号口
int slideR = 32;//设置滑动变阻器（电位器）引脚，支持32号口
int lightR = 33;//设置光敏电阻引脚，支持33口
int show_teacher_time = 0;
int button2In = 17;
bool is_showed = false;
const PROGMEM char HaveStart_Text[]{
0x80,0x82,0x82,0x82,0xFE,0x82,0x82,0x82,0x82,0x82,0xFE,0x82,0x82,0x82,0x80,0x00,
0x00,0x80,0x40,0x30,0x0F,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,/*"开",0*/

0x10,0x10,0xD0,0xFF,0x90,0x10,0x00,0xFE,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,0x00,
0x04,0x03,0x00,0xFF,0x00,0x83,0x60,0x1F,0x00,0x00,0x00,0x3F,0x40,0x40,0x78,0x00,/*"机",1*/

0x00,0xFC,0x84,0x84,0x84,0xFC,0x00,0x10,0x10,0x10,0x10,0x10,0xFF,0x10,0x10,0x00,
0x00,0x3F,0x10,0x10,0x10,0x3F,0x00,0x00,0x01,0x06,0x40,0x80,0x7F,0x00,0x00,0x00,/*"时",2*/

0x80,0x80,0x80,0x80,0xFF,0x80,0x80,0xA0,0x90,0x88,0x84,0x82,0x80,0x80,0x80,0x00,
0x00,0x00,0x00,0x00,0xFF,0x40,0x21,0x12,0x04,0x08,0x10,0x20,0x20,0x40,0x40,0x00,/*"长",3*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"：",4*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",5*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",6*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",7*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",8*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",9*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",10*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",11*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",12*/
};
void displayCN(int x,int y,int buffer[],int num){
  for(int seq = 0;seq < num;seq++){
    for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y,HaveStart_Text[32*(buffer[seq] - 1)+i]);
    }  
     for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y + 8,HaveStart_Text[32*(buffer[seq] - 1)+16+i]);
    }   
  }
}

const PROGMEM char Leading_Teacher1[]={
  0x10,0x10,0x10,0xFF,0x10,0x90,0x00,0x3F,0x48,0x48,0x44,0x44,0x44,0x42,0x70,0x00,
0x04,0x44,0x82,0x7F,0x01,0x00,0x00,0xFF,0x49,0x49,0x49,0x49,0x49,0xFF,0x00,0x00,/*"指",0*/

0x00,0x00,0x7E,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0x9E,0x80,0xE0,0x00,0x00,
0x04,0x04,0x04,0x04,0x0C,0x34,0x04,0x04,0x44,0x84,0x7F,0x04,0x04,0x04,0x04,0x00,/*"导",1*/

0x20,0xA4,0xA4,0xA4,0xFF,0xA4,0xB4,0x28,0x84,0x70,0x8F,0x08,0x08,0xF8,0x08,0x00,
0x04,0x0A,0x49,0x88,0x7E,0x05,0x04,0x84,0x40,0x20,0x13,0x0C,0x33,0x40,0x80,0x00,/*"教",2*/

0x00,0xFC,0x00,0x00,0xFF,0x00,0x02,0xE2,0x22,0x22,0xFE,0x22,0x22,0xE2,0x02,0x00,
0x00,0x87,0x40,0x30,0x0F,0x00,0x00,0x1F,0x00,0x00,0xFF,0x08,0x10,0x0F,0x00,0x00,/*"师",3*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*"：",4*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",5*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",6*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",7*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",8*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",9*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",10*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",11*/
};
const PROGMEM char Leading_Teacher2[] = {


0x20,0x20,0x24,0x24,0x24,0x24,0xBF,0x64,0x24,0x34,0x28,0x24,0x22,0x20,0x20,0x00,
0x10,0x08,0x04,0x02,0x3F,0x45,0x44,0x44,0x42,0x42,0x42,0x41,0x78,0x00,0x00,0x00,/*"老",3*/

0x00,0xFC,0x00,0x00,0xFF,0x00,0x02,0xE2,0x22,0x22,0xFE,0x22,0x22,0xE2,0x02,0x00,
0x00,0x87,0x40,0x30,0x0F,0x00,0x00,0x1F,0x00,0x00,0xFF,0x08,0x10,0x0F,0x00,0x00,/*"师",4*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",5*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",6*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",7*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",8*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",9*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",10*/

};

const PROGMEM char Leading_Teacher3[] = {


0x20,0x20,0x24,0x24,0x24,0x24,0xBF,0x64,0x24,0x34,0x28,0x24,0x22,0x20,0x20,0x00,
0x10,0x08,0x04,0x02,0x3F,0x45,0x44,0x44,0x42,0x42,0x42,0x41,0x78,0x00,0x00,0x00,/*"老",3*/

0x00,0xFC,0x00,0x00,0xFF,0x00,0x02,0xE2,0x22,0x22,0xFE,0x22,0x22,0xE2,0x02,0x00,
0x00,0x87,0x40,0x30,0x0F,0x00,0x00,0x1F,0x00,0x00,0xFF,0x08,0x10,0x0F,0x00,0x00,/*"师",4*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",5*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",6*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",7*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",8*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",9*/

0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*" ",10*/
};
void display_teacher_1(int x,int y,int buffer[],int num){
  for(int seq = 0;seq < num;seq++){
    for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y,Leading_Teacher1[32*(buffer[seq] - 1)+i]);
    }  
     for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y + 8,Leading_Teacher1[32*(buffer[seq] - 1)+16+i]);
    }   
  }
}
void display_teacher_2(int x,int y,int buffer[],int num){
  for(int seq = 0;seq < num;seq++){
    for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y,Leading_Teacher2[32*(buffer[seq] - 1)+i]);
    }  
     for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y + 8,Leading_Teacher2[32*(buffer[seq] - 1)+16+i]);
    }   
  }
}
void display_teacher_3(int x,int y,int buffer[],int num){
  for(int seq = 0;seq < num;seq++){
    for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y,Leading_Teacher3[32*(buffer[seq] - 1)+i]);
    }  
     for(int i = 0;i<16;i++){
      ssd1306_putPixels(x+16*seq+i,y + 8,Leading_Teacher3[32*(buffer[seq] - 1)+16+i]);
    }   
  }
}
int sliRRead(){//读取滑动变阻器模拟输入值
  return analogRead(slideR);
}
int lightRead(){//读取光敏电阻模拟值
  return analogRead(lightR);
}
void Mode1(){//模式1——旋钮控制
  analogWrite(lightIn,map(sliRRead(),0,4096,255,20));//通过旋钮电位器控制小灯亮度
}
void Mode2(){
  analogWrite(lightIn,map(lightRead(),0,4096,20,255));//通过光敏电阻控制小灯亮度
}
float get_distance(){//超声波测距
  digitalWrite(12,LOW);
  delayMicroseconds(2);
  digitalWrite(12,HIGH);
  delayMicroseconds(2);
  digitalWrite(12,LOW);
  float result = pulseIn(13,HIGH) / 58.00;
  delay(10);
  return result;
}
void setup() {
  // put your setup code here, to run once:
  Serial.begin(115200);//设置打印串口比特率
  pinMode(buttonIn,INPUT);//设置切换按钮的处理方式（输入或输出，按钮为输入）
  ssd1306_128x64_i2c_init();
  ssd1306_fillScreen(0x00);//初始化oled并清屏
  pinMode(12,OUTPUT);
  pinMode(13,INPUT);
  pinMode(button2In,INPUT);
}
void Timer(int second){//固定模板，使oled显示中文
  if(is_showed == true && millis() - show_teacher_time >= 3000){
    is_showed = false;
    ssd1306_fillScreen(0x00);
  }
  if (millis() - show_teacher_time >= 3000 and millis() != 0){
    is_showed = false;
  }
  if(is_showed){//利用boolean的性质，省略==true
    int num_CN;
    int CN[]={1,2,3,4,5,6,7,8};
    num_CN = sizeof(CN) / sizeof(CN[0]);
    display_teacher_1(0,8,CN,num_CN);
    num_CN = 0;
    num_CN = sizeof(CN) / sizeof(CN[0]);
    display_teacher_2(0,32,CN,num_CN);
    num_CN = 0;
    num_CN = sizeof(CN) / sizeof(CN[0]);
    display_teacher_3(0,48,CN,num_CN);
    num_CN = 0;
  }
  else{
    int num_CN;
    int CN[]={1,2,3,4,5,6,7,8};
    num_CN = sizeof(CN) / sizeof(CN[0]);
    displayCN(0,8,CN,num_CN);
    num_CN = 0;
    ssd1306_setFixedFont(ssd1306xled_font6x8);
    //ssd1306_clearScreen();
    ssd1306_printFixedN(0, 32, String(second).c_str(), STYLE_NORMAL, FONT_SIZE_2X);
  }
}
void loop() {
  // put your main code here, to run repeatedly:
  //测试串口输出部分
  Serial.println(digitalRead(button2In));
  //
  if(digitalRead(button2In) == 1){
    show_teacher_time = millis();
    is_showed = true;
  }
  if(digitalRead(buttonIn) == 0){//判断按钮是否被按下，被按下值为0
    if(states == 1){
      states = 0;//从另一个状态切换时变为0
    }
    else{
      states++;//states++可写成states = states + 1;将状态+1
    }
    delay(200);//延时200毫秒防止切换频繁
  }
  if(get_distance() <= 55){
    if(states == 0){
      Mode1();  //旋钮控制
    }
    else if(states == 1){
      Mode2();  //光敏控制
    }
  }
  else{
    analogWrite(lightIn,0);//如果没人就关灯
  }
    Timer(millis() / 1000);
  
}

